% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/misc_functions.R
\name{read_parquet_dt}
\alias{read_parquet_dt}
\title{Read Parquet (partitioned dataset or single file) via Arrow, optionally filter/project, return data.table}
\usage{
read_parquet_dt(
  path,
  cols = NULL,
  filter = NULL,
  partitioning = "hive",
  as_data_table = TRUE,
  keys_fallback = NULL
)
}
\arguments{
\item{path}{Character scalar (directory or file) OR character vector of parquet files.}

\item{cols}{Optional character vector of columns to keep (projection). NULL keeps all.}

\item{filter}{Optional row filter as an arrow::Expression.
Use `arrow::Expression$field_ref("colname")` to reference columns.
Example: `arrow::Expression$field_ref("year") >= 2018`}

\item{partitioning}{Partitioning spec for datasets. Default "hive" is typical for col=value/ layouts.
If opening fails with this, the function automatically retries without partitioning.}

\item{as_data_table}{Logical; if TRUE returns data.table; if FALSE returns data.frame.}

\item{keys_fallback}{Optional character vector of column names to use as data.table keys
if no key metadata is found in the parquet file. This allows specifying default keys
when reading parquet files that were not written with data.table key information.
The keys are only applied if all specified columns exist in the result.}
}
\value{
data.table (default) or data.frame
}
\description{
Read Parquet (partitioned dataset or single file) via Arrow, optionally filter/project, return data.table
}
\details{
When `as_data_table = TRUE`, the function attempts to restore data.table keys
from parquet metadata. Keys are stored in the parquet file's metadata under
the field `r.data.table.keys` as a JSON-encoded character vector (written by
functions like `arrow::write_parquet()` when custom metadata is provided).

The key restoration logic follows this priority:
\enumerate{
  \item Read keys from parquet metadata field `r.data.table.keys` (JSON-encoded)
  \item If no metadata keys found and `keys_fallback` is provided, use `keys_fallback`
  \item Keys are only applied if all key columns exist in the resulting data.table
}
}
\examples{
\dontrun{
# Single file:
dt <- read_parquet_dt("./data/myfile.parquet")

# Partitioned dataset directory with column selection:
dt <- read_parquet_dt(
  "./inputs/exposure_distributions/smok_status_table",
  cols = c("patid", "year", "smoke_status")
)

# With filter (requires arrow expressions):
dt <- read_parquet_dt(
  "./data/myfile.parquet",
  filter = arrow::Expression$field_ref("age") >= 40
)

# With fallback keys (applied if parquet has no key metadata):
dt <- read_parquet_dt(
  "./data/myfile.parquet",
  keys_fallback = c("patid", "year")
)
}
}
